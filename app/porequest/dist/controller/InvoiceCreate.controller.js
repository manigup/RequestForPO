sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/ui/model/Filter","sap/m/MessageBox","sap/ui/model/SimpleType"],function(e,t,i,s,o,a){"use strict";return e.extend("com.extension.porequest.controller.InvoiceCreate",{onInit:function(){this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.getView().setModel(new t([]),"AttachmentModel");this.getView().setModel(new t(sessionStorage.getItem("CodeDetails")||[{code:"P39"}]),"CodeDetails");this.byId("invCreateTable").setSticky(["ColumnHeaders","HeaderToolbar"])},handleRouteMatched:function(e){if(e.getParameter("name")!=="InvoiceCreate"){return}this.byId("attachment").setUploadEnabled(true).removeAllItems();this.byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");this.id=e.getParameter("arguments").Id;this.invNo=e.getParameter("arguments").InvNum;if(this.id&&this.invNo){this.byId("invPage").setTitle("Edit Invoice - "+this.invNo);this.byId("createBtn").setVisible(false);this.byId("editBtn").setVisible(true);this.getView().getModel().read("/PoList(Id='"+this.id+"',InvoiceNumber='"+this.invNo+"')",{success:e=>{this.getView().setModel(new t(e),"HeaderModel");this.getView().getModel("HeaderModel").refresh(true);this.getView().getModel().read("/PoList(Id='"+this.id+"',InvoiceNumber='"+this.invNo+"')/Items",{success:e=>{this.getView().setModel(new t(e.results),"ItemModel");this.getView().getModel("ItemModel").refresh(true);this.getAttachments()}})}})}else{this.byId("invPage").setTitle("Upload New Invoice");this.byId("createBtn").setVisible(true);this.byId("editBtn").setVisible(false);this.byId("attachment").removeAllIncompleteItems();this.getView().setModel(new t({}),"HeaderModel");this.getView().setModel(new t([]),"ItemModel")}},onMatChange:function(e){this.unitCode=sessionStorage.getItem("unitCode")||"P01";var t=e.getParameter("value");this.sPath=e.getSource().getParent().getBindingContextPath().split("/")[1];var i=this.getOwnerComponent().getModel();return new Promise(function(e,s){i.callFunction("/getMaterialList",{method:"GET",urlParameters:{UnitCode:this.unitCode,ItemCode:t,ItemDescription:""},success:function(t,i){var s=this.getView().getModel("ItemModel").getData()[this.sPath];s.MatDesc=t.results[0].MaterialDescription;s.UOM=t.results[0].UOM;s.HSNCode=t.results[0].HSNCode;s.MatGroup=t.results[0].MaterialGroup;this.getView().getModel("ItemModel").refresh(true);e()}.bind(this),error:function(e){s(e)}})}.bind(this))},getAttachments:function(){this.getView().getModel().read("/Attachments",{filters:[new s("Id","EQ",this.id)],success:e=>{this.getView().getModel("AttachmentModel").setData(e.results);this.getView().getModel("AttachmentModel").refresh(true)}})},onInvoiceTypeChange:function(e){const t=e.getParameter("selectedItem").getBindingContext().getProperty("ApproverEmail");this.getView().getModel("HeaderModel").getData().Approver=t;this.getView().getModel("HeaderModel").refresh(true)},onAddItems:function(){var e=this.getView().getModel("ItemModel").getData();if(e.length>0){o.error("Cannot add more than one item")}else{this.getView().getModel("ItemModel").getData().push({});this.getView().getModel("ItemModel").refresh(true)}},onCreatePress:function(){if(this.validateReqFields(["invDate","invNo","invAmmount","gst","invType","reqname","reqdep","reqcon","reqemail","pCode"])&&this.byId("attachment").getIncompleteItems().length>0){i.show();const e=this.getView().getModel("HeaderModel").getData();setTimeout(()=>{this.getView().getModel().create("/PoList",e,{success:async e=>{this.toAddress=e.Approver;this.invNo=e.InvoiceNumber;this.id=e.Id;await this.onInvItemSave();this.doAttachment()},error:()=>i.hide()})},500)}else{o.error("Please fill all required inputs to proceed")}},onEditPress:function(e){this.dialogSource=e.getSource();if(this.validateReqFields(["invDate","invNo","invAmmount","gst","invType","reqname","reqdep","reqcon","reqemail","pCode"])){i.show();const e=this.getView().getModel("HeaderModel").getData();e.Action="E";e.Items=this.getView().getModel("ItemModel").getData();setTimeout(()=>{this.getView().getModel().update("/PoList(InvoiceNumber='"+this.invNo+"',Id='"+this.id+"')",e,{success:()=>{this.toAddress=e.Approver;if(this.byId("attachment").getIncompleteItems().length>0){this.doAttachment()}else{i.hide();o.success("Invoice "+this.invNo+" updated successfully",{onClose:()=>{this.sendEmailNotification("Invoice "+this.invNo+" updated by supplier "+sap.ui.getCore().loginEmail.split("@")[0]+".");this.onNavBack()}})}},error:()=>i.hide()})},500)}else{o.error("Please fill all required inputs to proceed")}},onInvItemSave:async function(){i.show();var e=this.getView().getModel("ItemModel").getData();try{for(var t=0;t<e.length;t++){e[t].InvoiceNumber_Id=this.id;e[t].InvoiceNumber_InvoiceNumber=this.invNo;await this.createPoListItem(e[t])}}catch(e){i.hide();var s=e.responseJSON?e.responseJSON.error.message.value:"Error occurred while saving PoListItems.";o.error(s);throw e}i.hide()},createPoListItem:function(e){return new Promise((t,i)=>{this.getView().getModel().create("/PoListItems",e,{success:t,error:i})})},validateReqFields:function(e){let t=[],i,s;e.forEach(e=>{i=this.byId(e);s=i.getMetadata().getName()==="sap.m.Select"?i.getSelectedKey():i.getValue();if(s===""){i.setValueState("Error").setValueStateText("Required");t.push(false)}else{i.setValueState("None");t.push(true)}});if(t.every(e=>e===true))return true;else return false},doAttachment:function(){this.items=this.byId("attachment").getIncompleteItems();this.byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)},onAttachItemAdd:function(e){this.byId("attachment").setUploadEnabled(false);e.getParameter("item").setVisibleEdit(false).setVisibleRemove(false)},onBeforeUploadStarts:function(e){e.getParameter("item").addHeaderField(new sap.ui.core.Item({key:"slug",text:this.id+"/"+e.getParameter("item").getFileName()}))},onUploadComplete:function(){if(this.byId("attachment").getIncompleteItems().length===0){i.hide();let e,t;if(this.byId("invPage").getTitle().includes("Edit")){e=" updated by supplier ",t=" updated "}else{e=" uploaded by supplier ",t=" uploaded "}o.success("Invoice "+this.invNo+t+"successfully",{onClose:()=>{this.sendEmailNotification("Invoice "+this.invNo+e+sap.ui.getCore().loginEmail.split("@")[0]+".");this.onNavBack()}})}else{this.byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)}},onAttachmentUploadComplete:function(){if(this.byId("attachment").getIncompleteItems().length>0){this.byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)}},sendEmailNotification:function(e){const t=window.location.origin+"/site/SP#porequest-manage?sap-ui-app-id-hint=saas_approuter_com.extension.porequest";return new Promise((i,s)=>{const o=`|| ${e} Kindly log-in with the link to take your action.<br><br><a href='${t}'>CLICK HERE</a>`,a=this.getView().getModel(),n={method:"GET",urlParameters:{content:o,toAddress:this.toAddress},success:function(e){console.log("Email sent successfully.");i(e)},error:function(e){console.log("Failed to send email.");s(e)}};a.callFunction("/sendEmail",n)})},calcTotalVal:function(){let e=0,t=0;this.getView().getModel("ItemModel").getData().forEach(i=>{e+=parseFloat(i.LineValue)||0;t+=(parseFloat(i.IGSTAmt)||0)+(parseFloat(i.CGSTAmt)||0)+(parseFloat(i.SGSTAmt)||0)});let i=this.getView().getModel("HeaderModel").getData();i.TotalInvoiceAmount=e.toFixed(2);i.GSTAmt=t.toFixed(2);this.getView().getModel("ItemModel").refresh(true);this.getView().getModel("HeaderModel").refresh(true)},onTaxCodeChange:function(e){const t=e.getSource().getBindingContext("ItemModel").getObject();t.BaseAmt=parseFloat(t.Qty||0)*parseFloat(t.Rate||0);t.IGSTAmt=parseFloat((parseFloat(t.IGST)/100*t.BaseAmt).toFixed(2))||0;t.CGSTAmt=parseFloat((parseFloat(t.CGST)/100*t.BaseAmt).toFixed(2))||0;t.SGSTAmt=parseFloat((parseFloat(t.SGST)/100*t.BaseAmt).toFixed(2))||0;t.LineValue=parseFloat((t.BaseAmt+t.IGSTAmt+t.CGSTAmt+t.SGSTAmt).toFixed(2));this.calcTotalVal()},onRowDeletePress:function(e){const t=e.getParameter("listItem").getBindingContext("ItemModel").getPath().split("/")[1];o.confirm("Are you sure ?",{actions:["YES","NO"],onClose:e=>{if(e==="YES"){this.getView().getModel("ItemModel").getData().splice(t,1);this.calcTotalVal()}}})},onNavBack:function(){const e=sap.ui.core.routing.History.getInstance(),t=e.getPreviousHash();if(t!==undefined){window.history.go(-1)}else{this.router.navTo("Upload")}},customEMailType:a.extend("email",{formatValue:function(e){return e},parseValue:function(e){return e},validateValue:function(e){var t=/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/;if(!e.match(t)){throw new ValidateException("'"+e+"' is not a valid e-mail address")}}})})});
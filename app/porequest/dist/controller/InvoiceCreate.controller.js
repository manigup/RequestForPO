sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/m/MessageBox"],function(e,t,i,a){"use strict";return e.extend("com.extension.porequest.controller.InvoiceCreate",{onInit:function(){this.getView().addStyleClass("sapUiSizeCompact");this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.DataModel=new sap.ui.model.json.JSONModel;this.DataModel.setSizeLimit(1e8);this.getView().setModel(this.DataModel,"DataModel");this.detailModel=new t([]);this.getView().setModel(this.detailModel,"detailModel");this.getView().byId("InvoiceCreateTable").setSticky(["ColumnHeaders","HeaderToolbar"])},handleRouteMatched:function(e){var t=this.byId("attachment");t.removeAllItems();this.byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");this.getView().getModel("detailModel").setData([])},onInvoiceTypeChange:function(e){const t=e.getParameter("selectedItem").getBindingContext().getProperty("ApproverEmail");this.getView().getModel("DataModel").getData().Approver=t;this.getView().getModel("DataModel").refresh(true)},onAddItems:function(e){var t=this.getView().getModel("detailModel").getData();t.push({MatCode:"",MatDesc:"",UOM:"",Rate:"",Qty:"",BaseAmt:"",IGST:"",CGST:"",SGST:""});this.getView().getModel("detailModel").refresh(true)},onCreatePress:function(e){if(this.validateReqFields(["invDate","invNo","invAmmount","gst","invType"])&&this.byId("attachment").getIncompleteItems().length>0){i.show();const e=this.getView().getModel("DataModel").getData();setTimeout(()=>{this.getView().getModel().create("/PoList",e,{success:async e=>{this.toAddress=e.Approver;this.invNo=e.InvoiceNumber;this.id=e.Id;await this.onInvItemSave();this.doAttachment()},error:()=>{i.hide()}})},500)}else{a.error("Please fill all required inputs to proceed")}},onInvItemSave:async function(){i.show();var e=this.getView().getModel("detailModel").getData();try{for(var t=0;t<e.length;t++){e[t].PoList_Id=this.id;e[t].PoList_InvoiceNumber=this.invNo;await this.createPoListItem(e[t])}}catch(e){i.hide();var s=e.responseJSON?e.responseJSON.error.message.value:"Error occurred while saving PoListItems.";a.error(s);throw e}i.hide()},createPoListItem:function(e){return new Promise((t,i)=>{this.getView().getModel().create("/PoListItems",e,{success:t,error:i})})},validateReqFields:function(e){let t=[],i,a;e.forEach(e=>{i=this.byId(e);a=i.getMetadata().getName()==="sap.m.Select"?i.getSelectedKey():i.getValue();if(a===""){i.setValueState("Error").setValueStateText("Required");t.push(false)}else{i.setValueState("None");t.push(true)}});if(t.every(e=>e===true))return true;else return false},doAttachment:function(){this.items=this.byId("attachment").getIncompleteItems();this.byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)},onAttachItemAdd:function(e){e.getParameter("item").setVisibleEdit(false).setVisibleRemove(false)},onBeforeUploadStarts:function(e){e.getParameter("item").addHeaderField(new sap.ui.core.Item({key:"slug",text:this.id+"/"+e.getParameter("item").getFileName()}))},onUploadComplete:function(){if(this.byId("attachment").getIncompleteItems().length===0){i.hide();a.success("Invoice "+this.invNo+" uploaded successfully",{onClose:()=>{const e="Invoice "+this.invNo+" uploaded by supplier "+sap.ui.getCore().loginEmail.split("@")[0]+".";this.sendEmailNotification(e);this.getView().getModel("DataModel").setData({});this.getView().getModel("detailModel").setData([]);this.onNavBack()}})}else{this.byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)}},onAttachmentUploadComplete:function(){if(this.byId("attachment").getIncompleteItems().length>0){this.byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)}},sendEmailNotification:function(e){const t=window.location.origin+"site/SP#porequest-manage?sap-ui-app-id-hint=saas_approuter_com.extension.porequest";return new Promise((i,a)=>{const s=`|| ${e} Kindly log-in with the link to take your action.<br><br><a href='${t}'>CLICK HERE</a>`,o=this.getView().getModel(),n={method:"GET",urlParameters:{content:s,toAddress:this.toAddress},success:function(e){console.log("Email sent successfully.");i(e)},error:function(e){console.log("Failed to send email.");a(e)}};o.callFunction("/sendEmail",n)})},onQuantityChange:function(e){const t=e.getParameter("newValue");var i=e.getSource().getParent().getBindingContextPath().split("/")[1];var a=this.detailModel.getData();a[i].Qty=t;if(a[i].Rate){a[i].BaseAmt=parseFloat(a[i].Qty)*parseFloat(a[i].Rate)}this.detailModel.refresh(true)},onRateChange:function(e){const t=e.getParameter("newValue");var i=e.getSource().getParent().getBindingContextPath().split("/")[1];var a=this.detailModel.getData();a[i].Rate=t;if(a[i].Qty){a[i].BaseAmt=parseFloat(a[i].Qty)*parseFloat(a[i].Rate)}this.detailModel.refresh(true)},onNavBack:function(){var e=sap.ui.core.routing.History.getInstance();var t=e.getPreviousHash();if(t!==undefined){window.history.go(-1)}else{var i=sap.ui.core.UIComponent.getRouterFor(this);i.navTo("Upload",{},true)}}})});
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/ui/model/Filter","sap/m/MessageBox"],function(e,t,o,s,i){"use strict";return e.extend("com.extension.porequest.controller.Upload",{onInit:function(){this.router=sap.ui.core.UIComponent.getRouterFor(this);this.tblTemp=this.byId("uploadTblTemp").clone();this.getView().setModel(new t({}),"Filter");this.getView().setModel(new t([]),"PoList")},onAfterRendering:function(){this.getData()},getData:function(){const e=this.getView().getModel("Filter").getData();let t=[];Object.keys(e).forEach(o=>{if(!jQuery.isEmptyObject(e[o])){t.push(new s(o,"EQ",e[o]))}});this.byId("uploadTbl").bindAggregation("items",{path:"/PoList",parameters:{expand:"Items"},filters:t,template:this.tblTemp})},onFilterClear:function(){this.getView().getModel("Filter").setData({});this.getView().getModel("Filter").refresh(true)},onItempress:function(e){const t=e.getParameter("listItem").getBindingContext().getObject();this.router.navTo("ItemDetails",{Id:t.Id,Inv_Num:t.InvoiceNumber})},onAddPress:function(){this.router.navTo("InvoiceCreate")},onInvNoPress:function(e){const t=e.getSource().getBindingContext().getObject();this.router.navTo("InvoiceCreate",{Id:t.Id,InvNum:t.InvoiceNumber})},onActionChange:function(e){const t=e.getSource(),s=t.getSelectedKey();this.actionEvt=e.getSource();this.obj=t.getBindingContext().getObject();i.confirm("Are you sure ?",{onClose:e=>{if(e==="YES"){this.invNo=this.obj.InvoiceNumber;this.id=this.obj.Id;this.toAddress=this.obj.createdBy;this.payload={Action:s};const e=sap.ui.xmlfragment("com.extension.porequest.fragment.Remarks",this),t=s==="A"?"Approval":"Rejection";this.getView().addDependent(e);e.setTitle(t);e.open();this.getView().getModel("PoList").setData([]);this.getView().getModel("PoList").refresh(true);if(s==="A"){sap.ui.getCore().byId("po").setVisible(true);o.show();this.getView().getModel("po").read("/PurchaseOrders",{urlParameters:{$expand:"DocumentRows",AddressCode:this.obj.AddressCode,UnitCode:this.obj.PlantCode},success:e=>{o.hide();const t=e.results.filter(e=>e.HasAttachments!=="Invoice Submitted");if(t.length>0){this.getView().getModel("PoList").setData(t);this.getView().getModel("PoList").refresh(true)}else{i.error("Po List is Empty")}},error:e=>{o.hide();i.error(JSON.parse(e.responseText).error.message.value)}})}else{sap.ui.getCore().byId("po").setVisible(false)}}},actions:["YES","NO"]})},onRemarksSubmit:function(e){this.dialogSource=e.getSource();const t=this.payload.Action==="A"?["po","remarks"]:["remarks"];if(this.validateReqFields(t)){this.payload.ApproverRemarks=sap.ui.getCore().byId("remarks").getValue();if(this.payload.Action==="A"){this.payload.PONumber=sap.ui.getCore().byId("po").getSelectedKey()}this.takeAction()}else{i.error("Please fill all required inputs to proceed")}},onDialogCancel:function(e){this.actionEvt.setSelectedKey();e.getSource().getParent().destroy()},onPoNumberChange:function(e){this.poEntryPayload=e.getParameter("selectedItem").getBindingContext("PoList").getObject()},createPoEntry:function(){o.show();const e={PNum_PoNum:this.poEntryPayload.PoNum.replace(/\//g,"-"),PlantName:this.poEntryPayload.PlantName,PlantCode:this.poEntryPayload.PlantCode,BillDate:this.obj.InvoiceNumber,BillNumber:this.obj.InvoiceDate,EwayBillNumber:this.obj.EwayBillNumber,EwayBillDate:this.obj.EwayBillDate,TotalCGstAmnt:this.obj.Items.results[0].CGSTAmt,TotalSGstAmnt:this.obj.Items.results[0].SGSTAmt,TotalIGstAmnt:this.obj.Items.results[0].IGSTAmt,TotalAmnt:this.obj.TotalInvoiceAmount};this.getView().getModel("po").create("/ASNListHeader",e,{success:()=>{o.hide()},error:e=>{o.hide();i.error(JSON.parse(e).error.message.value)}})},takeAction:function(){setTimeout(()=>{this.getView().getModel().update("/PoList(Id='"+this.id+"',InvoiceNumber='"+this.invNo+"')",this.payload,{success:()=>{o.hide();i.success("Action taken successfully",{onClose:()=>{let e;switch(this.payload.Action){case"A":e=" approved by purchase team.";break;case"R":e=" rejected by purchase team.";break}this.sendEmailNotification("Invoice "+this.invNo+e);this.dialogSource.getParent().destroy();this.getData();this.createPoEntry()}})},error:()=>o.hide()})},500)},validateReqFields:function(e){let t=[],o,s;e.forEach(e=>{o=sap.ui.getCore().byId(e);s=o.getMetadata().getName()==="sap.m.Select"?o.getSelectedKey():o.getValue();if(s===""){o.setValueState("Error").setValueStateText("Required");t.push(false)}else{o.setValueState("None");t.push(true)}});if(t.every(e=>e===true))return true;else return false},onAttachmentPress:function(e){o.show();const i=e.getSource(),r=i.getBindingContext().getProperty("Id");setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new s("Id","EQ",r)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(Id='"+e.Id+"',ObjectId='"+e.ObjectId+"')/$value");var s=sap.ui.xmlfragment("com.extension.porequest.fragment.Attachment",this);sap.ui.getCore().byId("attachPopover").setModel(new t(e),"AttachModel");this.getView().addDependent(s);s.openBy(i);o.hide()},error:()=>o.hide()})},1e3)},onPopOverClosePress:function(e){e.getSource().getParent().getParent().destroy()},onInvoiceTypeChange:function(e){const t=e.getParameter("selectedItem").getBindingContext().getProperty("ApproverEmail");this.getView().getModel("DataModel").getData().Approver=t;this.getView().getModel("DataModel").refresh(true)},sendEmailNotification:function(e){const t=window.location.origin+"/site/SP#porequest-manage?sap-ui-app-id-hint=saas_approuter_com.extension.porequest";return new Promise((o,s)=>{const i=`|| ${e} Kindly log-in with the link to take your action.<br><br><a href='${t}'>CLICK HERE</a>`,r=this.getView().getModel(),n={method:"GET",urlParameters:{content:i,toAddress:this.toAddress},success:function(e){console.log("Email sent successfully.");o(e)},error:function(e){console.log("Failed to send email.");s(e)}};r.callFunction("/sendEmail",n)})}})});
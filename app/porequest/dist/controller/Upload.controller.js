sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/ui/model/Filter","sap/m/MessageBox"],function(e,t,i,s,o){"use strict";return e.extend("com.extension.porequest.controller.Upload",{onInit:function(){this.tblTemp=this.byId("uploadTblTemp").clone();this.getView().setModel(new t,"DataModel");this.getView().setModel(new t({}),"EditModel");this.getView().setModel(new t([]),"AttachmentModel");this.getView().setModel(new t({}),"Filter")},onAfterRendering:function(){this.getData()},getData:function(){const e=this.getView().getModel("Filter").getData();let t=[];Object.keys(e).forEach(i=>{if(!jQuery.isEmptyObject(e[i])){t.push(new s(i,"EQ",e[i]))}});this.byId("uploadTbl").bindAggregation("items",{path:"/PoList",filters:t,template:this.tblTemp})},onFilterClear:function(){this.getView().getModel("Filter").setData({});this.getView().getModel("Filter").refresh(true)},onAddPress:function(){const e=sap.ui.xmlfragment("com.extension.porequest.fragment.Create",this);this.getView().addDependent(e);this.getView().getModel("DataModel").setData({});this.getView().getModel("DataModel").refresh(true);sap.ui.getCore().byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");e.open()},onInvNoPress:function(e){const t=e.getSource().getBindingContext().getObject();const i=sap.ui.xmlfragment("com.extension.porequest.fragment.Edit",this);this.getView().addDependent(i);this.getView().getModel("EditModel").setData(t);this.getView().getModel("EditModel").refresh(true);this.invNo=t.InvoiceNumber;this.id=t.Id;this.getAttachments();sap.ui.getCore().byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");i.open()},getAttachments:function(){this.getView().getModel().read("/Attachments",{filters:[new s("Id","EQ",this.id)],success:e=>{this.getView().getModel("AttachmentModel").setData(e.results);this.getView().getModel("AttachmentModel").refresh(true);i.hide()},error:()=>i.hide()})},onCreatePress:function(e){this.dialogSource=e.getSource();if(this.validateReqFields(["invDate","invNo","invAmmount","gst","invType"])&&sap.ui.getCore().byId("attachment").getIncompleteItems().length>0){i.show();const e=this.getView().getModel("DataModel").getData();setTimeout(()=>{this.getView().getModel().create("/PoList",e,{success:e=>{this.toAddress=e.Approver;this.invNo=e.InvoiceNumber;this.id=e.Id;this.doAttachment()},error:()=>i.hide()})},500)}else{o.error("Please fill all required inputs to proceed")}},onEditPress:function(e){this.dialogSource=e.getSource();if(this.validateReqFields(["invDate","invNo","invAmmount","gst","invType"])){i.show();const e=this.getView().getModel("EditModel").getData();e.Action="E";setTimeout(()=>{this.getView().getModel().update("/PoList(InvoiceNumber='"+this.invNo+"',Id='"+this.id+"')",e,{success:t=>{i.hide();o.success("Invoice "+t.InvoiceNumber+" updated successfully",{onClose:()=>{this.toAddress=e.Approver;const t="Invoice "+this.invNo+" updated by supplier "+sap.ui.getCore().loginEmail.split("@")[0]+".";this.sendEmailNotification(t);this.dialogSource.getParent().destroy();this.getData()}})},error:()=>i.hide()})},500)}else{o.error("Please fill all required inputs to proceed")}},onActionChange:function(e){const t=e.getSource(),i=t.getBindingContext().getObject(),s=t.getSelectedKey();o.confirm("Are you sure ?",{onClose:e=>{if(e==="YES"){this.invNo=i.InvoiceNumber;this.id=i.Id;this.toAddress=i.createdBy;this.payload={Action:s};const e=sap.ui.xmlfragment("com.extension.porequest.fragment.Remarks",this);this.getView().addDependent(e);const t=s==="A"?"Approval":"Rejection";if(s==="A"){sap.ui.getCore().byId("po").setVisible(true)}else{sap.ui.getCore().byId("po").setVisible(false)}e.setTitle(t);e.open()}},actions:["YES","NO"]})},onRemarksSubmit:function(e){this.dialogSource=e.getSource();const t=this.payload.Action==="A"?["po","remarks"]:["remarks"];if(this.validateReqFields(t)){this.payload.ApproverRemarks=sap.ui.getCore().byId("remarks").getValue();if(this.payload.Action==="A"){this.payload.PONumber=sap.ui.getCore().byId("po").getValue()}this.takeAction()}else{o.error("Please fill all required inputs to proceed")}},takeAction:function(){setTimeout(()=>{this.getView().getModel().update("/PoList(Id='"+this.id+"',InvoiceNumber='"+this.invNo+"')",this.payload,{success:()=>{i.hide();o.success("Action taken successfully",{onClose:()=>{let e;switch(this.payload.Action){case"A":e=" approved by purchase team.";break;case"R":e=" rejected by purchase team.";break}this.sendEmailNotification("Invoice "+this.invNo+e);this.dialogSource.getParent().destroy();this.getData()}})},error:()=>i.hide()})},500)},validateReqFields:function(e){let t=[],i,s;e.forEach(e=>{i=sap.ui.getCore().byId(e);s=i.getMetadata().getName()==="sap.m.Select"?i.getSelectedKey():i.getValue();if(s===""){i.setValueState("Error").setValueStateText("Required");t.push(false)}else{i.setValueState("None");t.push(true)}});if(t.every(e=>e===true))return true;else return false},doAttachment:function(){this.items=sap.ui.getCore().byId("attachment").getIncompleteItems();sap.ui.getCore().byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)},onAttachItemAdd:function(e){e.getParameter("item").setVisibleEdit(false).setVisibleRemove(false)},onBeforeUploadStarts:function(e){e.getParameter("item").addHeaderField(new sap.ui.core.Item({key:"slug",text:this.id+"/"+e.getParameter("item").getFileName()}))},onUploadComplete:function(){if(sap.ui.getCore().byId("attachment").getIncompleteItems().length===0){i.hide();o.success("Invoice "+this.invNo+" uploaded successfully",{onClose:()=>{const e="Invoice "+this.invNo+" uploaded by supplier "+sap.ui.getCore().loginEmail.split("@")[0]+".";this.sendEmailNotification(e);this.getView().getModel("DataModel").setData({});this.dialogSource.getParent().destroy();this.getData()}})}else{sap.ui.getCore().byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)}},onAttachmentUploadComplete:function(){if(sap.ui.getCore().byId("attachment").getIncompleteItems().length>0){sap.ui.getCore().byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)}},onAttachmentPress:function(e){i.show();const o=e.getSource(),a=o.getBindingContext().getProperty("Id");setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new s("Id","EQ",a)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(Id='"+e.Id+"',ObjectId='"+e.ObjectId+"')/$value");var s=sap.ui.xmlfragment("com.extension.porequest.fragment.Attachment",this);sap.ui.getCore().byId("attachPopover").setModel(new t(e),"AttachModel");this.getView().addDependent(s);s.openBy(o);i.hide()},error:()=>i.hide()})},1e3)},onDialogClose:function(e){e.getSource().destroy()},onDialogCancel:function(e){e.getSource().getParent().destroy()},onPopOverClosePress:function(e){e.getSource().getParent().getParent().destroy()},onInvoiceTypeChange:function(e){const t=e.getParameter("selectedItem").getBindingContext().getProperty("ApproverEmail");this.getView().getModel("DataModel").getData().Approver=t;this.getView().getModel("DataModel").refresh(true)},sendEmailNotification:function(e){const t=window.location.origin+"site/SP#porequest-manage?sap-ui-app-id-hint=saas_approuter_com.extension.porequest";return new Promise((i,s)=>{const o=`|| ${e} Kindly log-in with the link to take your action.<br><br><a href='${t}'>CLICK HERE</a>`,a=this.getView().getModel(),n={method:"GET",urlParameters:{content:o,toAddress:this.toAddress},success:function(e){console.log("Email sent successfully.");i(e)},error:function(e){console.log("Failed to send email.");s(e)}};a.callFunction("/sendEmail",n)})}})});